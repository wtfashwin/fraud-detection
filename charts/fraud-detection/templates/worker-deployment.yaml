apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "fraud-detection.fullname" . }}-worker
  labels:
    app: fraud-detection
    component: xai-worker
spec:
  replicas: 1  # Initial replica count, KEDA will manage scaling
  selector:
    matchLabels:
      app: fraud-detection
      component: xai-worker
  template:
    metadata:
      labels:
        app: fraud-detection
        component: xai-worker
    spec:
      containers:
      - name: worker
        image: "{{ .Values.worker.image.repository }}:{{ .Values.worker.image.tag }}"
        imagePullPolicy: {{ .Values.worker.image.pullPolicy }}
        command: ["celery", "-A", "xai_tasks", "worker", "--loglevel=info"]
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "fraud-detection.fullname" . }}-db
              key: DATABASE_URL
        # Updated to use Redis with Sentinel for HA
        - name: CELERY_BROKER_URL
          value: "sentinel://{{ include "fraud-detection.fullname" . }}-redis-master:26379/0"
        - name: OTEL_SERVICE_NAME
          value: "xai-worker"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: {{ .Values.otel.endpoint | quote }}
        resources:
          {{- toYaml .Values.worker.resources | nindent 12 }}
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "celery -A xai_tasks control shutdown"]
        readinessProbe:
          exec:
            command:
            - celery
            - -A
            - xai_tasks
            - inspect
            - ping
            - -d
            - celery@$HOSTNAME
          initialDelaySeconds: 15
          periodSeconds: 10